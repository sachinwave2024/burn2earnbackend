{% extends 'default_theme/base/__base.html' %}
{% load static %} 

{% load form_custom %}

{% block Style_sheets %}


{% endblock Style_sheets %}

 {% load render_table from django_tables2 %}

 {% block Content_Area %}
 <style>
  element.style {
    display: none;
}
</style>
    <section class="content">

      <div class="loader" id="loader_spin_id" style="display: none;">
        <div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>
        <div class="test" style="color: white; text-align: center;"><p> Transcation is process...<br> Please donâ€™t refresh the page.</p></div>
        </div>
  
     
   	 <div class="box box-default">
        <div class="box-header with-border">
          <h3 class="box-title">{{ Title}}</h3>
          <div class="box-tools pull-right">
          </div>
        </div>
     {% if messages %}
     {% for message in messages %}
     <div class="alert {{ message.tags }} alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}
  
    <input type="hidden" id="all_user_list" value="{{dict_withdraw}}">

    <div class="row">  
      <div class="col-md-6 col-xs-12 pull-left"> 
        <div class="row">
          <form class="form-horizontal" method="post"> 
            {% csrf_token %} 
          <div class="col-md-3">
        <!-- <div class="form-control"> -->
          <label>Start Date :</label>
          <input type="date" placeholder="Start Date" id="id_start_date" class="textinput textInput">
        </div>
        <!-- </div> -->
          <div class="col-md-3">
        <!-- <div class="form-control"> -->
          <label>End Date :</label>
          <input type="date" placeholder="End Date" id="id_end_date" class="textinput textInput">
          <p class="mt-2" id="blankMsgName" style="color: red;"></p>
        <!-- </div> -->
        </div>

        <div>
          <button type="button" class="btn btn-primary" onclick="CSV_file_ajax()">Download CSV</button>
        </div>
        </form>
        </div>
        
       </div>   
      <div class="col-md-6 col-xs-12 pull-right"> 
           <div class="panel-group accordion" id="accordion1">
                                                 <div class="panel panel-default">
                                                     <div class="panel-heading">
                                                         <div class="panel-title">
                                                             <a id="accordion-search" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion1" href="#collapse_1" aria-expanded="false">
                                                              <i class="fa fa-search font-dark"></i>
                                                        <span class="caption-subject font-dark bold uppercase">Advanced Search</span>
                                                        <span style="float:right"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
                                                             </a>
                                                             
                                                         </div>
                                                         
                                                     </div>
                                                     <div id="collapse_1" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                                                         <div class="panel-body">
                                                             

                                                              <form class="form-horizontal" id="Bill_Search_Form" method="post"> 
                                                                <div class="form">
                                                              <div id="div_id_Address" class="control-group">
                                                                 <label for="id_Address" class="control-label ">
                                                                              Address
                                                                          </label>
                                                                           <div class="controls"> 
                                                                            {% if request.GET.Address != None %}
                                                                             <input type="text" name="Address" class="textinput textInput" value=" {{request.GET.Address}}" id="id_Address"> 
                                                                             {% else %}
                                                                             <input type="text" name="Address" class="textinput textInput" id="id_Address"> 
                                                                             {% endif %}
                                                                            </div> 
                                                                          </div> 
                                                            <div id="div_id_date" class="control-group"> 
                                                              <label for="id_date" class="control-label ">
                                                                Date
                                                                </label> <div class="controls"> 
                                                                  {% if request.GET.date != None %}
                                                                  <input type="date" name="date" class="textinput textInput" value="{{request.GET.date}}" id="id_date"> 
                                                                  {% else %}
                                                                  <input type="Date" name="date" class="textinput textInput" id="id_date"> 
                                                                  {% endif %}
                                                                </div> 
                                                            </div>
                                                            <div id="div_id_email" class="control-group">
                                                              <label for="id_email" class="control-label ">
                                                                           email
                                                                       </label>
                                                                        <div class="controls"> 
                                                                         {% if request.GET.email != None %}
                                                                          <input type="text" name="email" class="textinput textInput" value=" {{request.GET.email}}" id="id_email"> 
                                                                          {% else %}
                                                                          <input type="text" name="email" class="textinput textInput" id="id_email"> 
                                                                          {% endif %}
                                                                         </div> 
                                                                       </div>

                                                                    <div id="div_id_status" class="control-group" style="position: absolute;top: 107px;left: 269px;">
                                                                    <label for="id_status" class="control-label ">
                                                                          status
                                                                      </label>
                                                                      <div class="controls"> 
                                                                        {% if request.GET.status != None %}
                                                                        <input type="text" name="status" class="textinput textInput" value=" {{request.GET.status}}" id="id_status"> 
                                                                        {% else %}
                                                                        <input type="text" name="status" class="textinput textInput" id="id_status"> 
                                                                        {% endif %}
                                                                        </div> 
                                                                      </div>
                                                        
                                                              </div>
                                                              <div class="form-actions"> 
                                                                <input type="submit" name="submit" value="Search" class="btn btn-primary" id="submit-id-submit">
                                                                 <input type="reset" name="reset-search" value="Reset Search" class="btn btn-inverse btn btn-default" id="reset-search">
                                                                
                                                                 </div> 

                                              
                                                               </form>
                                                            </div>
                                                                       
                                                              
                                                                                                                       
                                                         </div>
                                                     </div>
                                                 </div>
                                             </div>  
                                        
      </div>

      <style>
        .pagination{
          padding-left: 700px;
        }
        .form{
          display: flex;
        }
        .form .control-group{
       
          margin-right: 15px;
          margin-bottom: 15px;
        }
        #example1_info {
   padding: 25px 0;
  }
  
  .pagination {
   /* padding-left: 1015px; */
   float: right;
  }
      </style>
     
   
      <div class="box">
            <div class="box-header">
              <h3 class="box-title"></h3>
              <input type="hidden" id="id_value" value="" >
              <div class="box-tools pull-right">                         
                        </div>
            </div>
            <div id="successCount">Success Count:</div>
            <div id="failCount">Fail Count:</div>
            
             <div class="table-responsive">
              <div class="box-footer">
                <button class="btn btn-primary approve-btn" onclick= "withdraw_process()" style="">Approve</button>                 
        </div>
            <div class="box-body">
              <table id="examples" class="display" style="width:100%">
                <thead>
                    <tr>
                  <th  class="no-sort">S.No</th>
                  <th  class="no-sort">Tick</th>
                  <th  class="no-sort">Username</th>
                  <th  class="no-sort">Email</th>
                  <th  class="no-sort">Wallet Type</th>
                  <th  class="no-sort">Amount(USDT)</th>
                  <th  class="no-sort">Address</th>
                  <th  class="no-sort">Fees(%)</th>
                  <th  class="no-sort">Claim Amount(USDT)</th>
                  <th  class="no-sort">Claim Amount(JW)</th>
                  <th  class="no-sort">Created on</th>
                  <th  class="no-sort">Status</th>
                  <th  class="no-sort">Action</th>
                  <th  class="no-sort">Hold Payout</th>


                    </tr>
                </thead>
            </table>
              
            </div>
            </div>
          
          </div>
        
      </div>

    </section>
 {% endblock Content_Area %}
 {% block Java_Scripts %}


 <script src="https://cdn.tutorialjinni.com/jquery-csv/1.0.11/jquery.csv.min.js"></script>

 


<script>
  $("#reset-search").click(function(){
     window.location = "/tradeadmin/manual_withdraw_INR/";
     });
   
</script>


<script>
  function CSV_file_ajax() {
    $("#loader_spin_id").show();
     $.ajax({
         type: "POST",
         url: '/tradeadmin/download_csv/', 
         data: {
             start_date : $("#id_start_date").val(), 
             end_date : $("#id_end_date").val(), 
             csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
         },
         success:function(data)
         {
           if(data.start_date != "" && data.end_date != ""){
              if(data.start_date <= data.end_date){
                  if(data.data != ""){
                    
                      if (data.status == "true") {
                        
                        const str_date = data.start_date
                        const end_date = data.end_date

                        const csv = $.csv.fromObjects(data.data);
                        downloadBlobAsFile(csv, str_date + '_to_' + end_date + ' transaction.csv' );
                        $("#loader_spin_id").hide();
                      } else {
                        alert("No records found !!!!")
                        $("#loader_spin_id").hide();
                      }
                }else{
                  alert("No records found.")
                  $("#loader_spin_id").hide();
              }
            }else{
              alert("Invalid end date.")
              $("#loader_spin_id").hide();
            }
          }else{
            alert("Make sure select date.")
            $("#loader_spin_id").hide();
          }
         },
     });
     };

    const downloadBlobAsFile = function(csv, filename){
      var downloadLink = document.createElement("a");
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = filename;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

 </script>


<script>
  function end_date_validate(){
    var str_date = $("#id_start_date").val();
    var end_date = $("#id_end_date").val();
    
    if (str_date < end_date){
      document.getElementById("blankMsgName").innerHTML = "";
    }else{
      document.getElementById("blankMsgName").innerHTML = "Select valid date";
    }

  }
</script>

<style>
/*-- -- -- -- -|| Loader Styles Start Here ||- -- -- -- --*/
.loader {
    background: rgba(0, 4, 10, 0.9) none repeat scroll 0 0;
    bottom: 0;
    height: 100%;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    width: 100%;
    z-index: 9999;
}
.spinner {
    height: 40px;
    margin: auto;
    position: absolute;
    width: 40px;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
}
.double-bounce1, .double-bounce2 {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #fff;
    opacity: 0.6;
    position: absolute;
    top: 0;
    left: 0;
    -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
    animation: sk-bounce 2.0s infinite ease-in-out;
}
.double-bounce2 {
    -webkit-animation-delay: -1.0s;
    animation-delay: -1.0s;
}
/*-- -- -- -- -|| Loader Styles End Here ||- -- -- -- --*/

</style>
<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css" />

<script src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
  var table =  $('#examples').DataTable({
    bFilter: false,
    ajax: {
      url: '/tradeadmin/getmultiplewithdrawUsersinr/',
      type: 'POST',
      data: function (d) {
        d.id_Address = $('#id_Address').val();
        d.id_date = $('#id_date').val();
        d.id_email = $('#id_email').val();
        d.id_status = $('#id_status').val();
      },
    },
    columns: [
      {
        data: null,
      },
      {
        data: null,
        render: function (data, type, row) {
          if (row['status'] == 3) {
            return '<input type="checkbox" class="row-checkbox" data-id="' + row['id'] + '" title="Tick">';
          } else if (row['status'] == 1) {
            return "----";
          }
          return data;
        },
      },
      { data: 'back_up_phrase' },
      { data: 'Month_stake' },
      { data: 'Wallet_type' },
      { data: 'Amount' },
      { data: 'Address' },
      { data: 'Withdraw_fee' },
      { data: 'Withdraw_USDT' }, 
      { data: 'Withdraw_JW' }, 
      { data: 'created_on' },
      {
        data: null,
        render: function (data, type, row) {
          if (row['status'] == 1) {
            return 'Completed';
          } else if (row['status'] == 2) {
            return 'Cancelled';
          } else if (row['status'] == 3) {
            return 'Active';
          }
          else if (row['status'] == 4) {
            return 'Hold';
          }
          return data;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (row['status'] == 3) {
            return '<a class="btn" href="/tradeadmin/manual_Withdraw_Request/' + row['id'] + '/"><i class="fa fa-edit "></i></a>';
          } else if (row['status'] == 1) {
            return "----";
          }
          return data;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (row['status'] == 3) {
            return '<a class="btn" href="/tradeadmin/user_hold_payment/' + row['id'] + '/"><i class="fa fa-server "></i></a>';
          } else if (row['status'] == 1) {
            return "----";
          }
          return data;
        },
      },
    ],
    processing: true,
    serverSide: true,
    drawCallback: function (settings) { 
      var response = settings.json;
      $('.sorting_1').each(function(i){
        $(this).html(response.tt[i]);
      });
    }, 
  });

  $(document).ready(function() {
  var selectedIds = []; 


  $('#examples tbody').on('change', 'input.row-checkbox', function() {
    var rowData = table.row($(this).closest('tr')).data();
    var id = rowData['id'];

    if ($(this).prop('checked')) {
      selectedIds.push(id);
    } else {
      selectedIds = selectedIds.filter(function(selectedId) {
        return selectedId !== id;
      });
    }
    document.getElementById("id_value").value =selectedIds;
  });

  $("#Bill_Search_Form").on("submit", function(event) {
    event.preventDefault();
    
  });
});
});
</script>

<script>
  function withdraw_process() {
    var idString = document.getElementById("id_value").value;
    var cleanedIdString = idString.replace(/'/g, '"').replace(/^\[|\]$/g, '');
    var array = JSON.parse('[' + cleanedIdString + ']');
    var successCount = 0;

    
    var failCount = 0;

    function updateCounts() {
      $('#successCount').text('Success Count: ' + successCount);
      $('#failCount').text('Fail Count: ' + failCount);
    }

    function makeRequestAndReload(id) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: '/tradeadmin/Admin_approve_withdrawinr/' + id + '/',
          type: 'GET',
          success: function (data) {
            console.log('Django View Response:', data);
            $("#loader_spin_id").hide();
            successCount++;
            updateCounts();
            resolve();
          },
          error: function (error) {
            console.error('Error calling Django View:', error);
            $("#loader_spin_id").hide();
            failCount++;
            updateCounts();
            reject();
          }
        });
      });
    }

    function processElement(index) {
      if (index < array.length) {
        $("#loader_spin_id").show();
        const element = array[index];
        makeRequestAndReload(element)
          .then(() => {
            setTimeout(function () {
              processElement(index + 1);
            }, 60);
          })
          .catch(() => {
            setTimeout(function () {
              processElement(index + 1);
            }, 60);
          });
      } else {
        updateCounts();
        localStorage.setItem('successCount', successCount);
        localStorage.setItem('failCount', failCount);
        setTimeout(function () {
          localStorage.clear();
          location.reload();
        }, 3000);
      }
    }
    successCount = parseInt(localStorage.getItem('successCount')) || 0;
    failCount = parseInt(localStorage.getItem('failCount')) || 0;

    processElement(0);
  }
</script>


 {% endblock %}


