{% extends 'default_theme/base/__base.html' %}
{% load static %} 

{% load form_custom %}

{% block Style_sheets %}


{% endblock Style_sheets %}

 {% load render_table from django_tables2 %}

 {% block Content_Area %}
 
    <section class="content">
  
      <div class="loader" id="loader_spin_id" style="display: none;">
        <div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>
        <div class="test" style="color: white; text-align: center;"><p> File download in process...<br> Please donâ€™t refresh the page.</p></div>
        </div>
     
   	 <div class="box box-default">
        <div class="box-header with-border">
          <h3 class="box-title">{{ Title}}</h3>
          <div class="box-tools pull-right">
          </div>
        </div>
     {% if messages %}
     {% for message in messages %}
     <div class="alert {{ message.tags }} alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}
  
    <input type="hidden" id="all_user_list" value="{{dict_withdraw}}">

    <div class="row ">   
      <div class="col-md-6 col-xs-12 pull-left"> 
        <div class="row">
          <form class="form-horizontal" method="post"> 
            {% csrf_token %} 
          <div class="col-md-3">
        <!-- <div class="form-control"> -->
          <label>Start Date :</label>
          <input type="date" placeholder="Start Date" id="id_start_date" class="textinput textInput">
        </div>
        <!-- </div> -->
          <div class="col-md-3">
        <!-- <div class="form-control"> -->
          <label>End Date :</label>
          <input type="date" placeholder="End Date" id="id_end_date" class="textinput textInput">
          <p class="mt-2" id="blankMsgName" style="color: red;"></p>
        <!-- </div> -->
        </div>

        <div>
          <button type="button" class="btn btn-primary" onclick="Send_Withdraw_CSV_file_ajax()">Download CSV</button>
        </div>
        </form>
        </div>
        
       </div> 
      <div class="col-md-6 col-xs-12 pull-right"> 
           <div class="panel-group accordion" id="accordion1">
                                                 <div class="panel panel-default">
                                                     <div class="panel-heading">
                                                         <div class="panel-title">
                                                             <a id="accordion-search" class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#accordion1" href="#collapse_1" aria-expanded="false">
                                                              <i class="fa fa-search font-dark"></i>
                                                        <span class="caption-subject font-dark bold uppercase">Advanced Search</span>
                                                        <span style="float:right"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
                                                             </a>
                                                             
                                                         </div>
                                                         
                                                     </div>
                                                     <div id="collapse_1" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                                                         <div class="panel-body">
                                                             

                                                              <form class="form-horizontal" id="Bill_Search_Form" method="get"> 
                                                                <div class="form">
                                                              <div id="div_id_email" class="control-group"> 
                                                                <label for="id_email" class="control-label ">
                                                              
                                                                            Email
                                                              </label> 
                                                              <div class="controls">
                                                                {% if request.GET.email != None %} 
                                                                <input type="text" name="email" class="textinput textInput" value=" {{request.GET.email}}" id="id_email"> 
                                                                {% else %}
                                                                <input type="text" name="email" class="textinput textInput" id="id_email"> 
                                                                {% endif%}
                                                              </div> 
                                                            </div> 

                                                            <div id="div_id_wallet_address" class="control-group"> 
                                                              <label for="id_wallet_address" class="control-label ">
                                                            
                                                                          wallet_address
                                                            </label> 
                                                            <div class="controls">
                                                              {% if request.GET.wallet_address != None %} 
                                                              <input type="text" name="wallet_address" class="textinput textInput" value=" {{request.GET.wallet_address}}" id="id_wallet_address"> 
                                                              {% else %}
                                                              <input type="text" name="wallet_address" class="textinput textInput" id="id_wallet_address"> 
                                                              {% endif%}
                                                            </div> 
                                                          </div> 
                                                            
                                                              </div>
                                                              <div class="form-actions"> 
                                                                <input type="submit" name="submit" value="Search" class="btn btn-primary" id="submit-id-submit">
                                                                 <input type="reset" name="reset-search" value="Reset Search" class="btn btn-inverse btn btn-default" id="reset-search">
                                                                 </div> 
                                                               </form>
                                                            </div>
                                                                       
                                                              
                                                                                                                       
                                                         </div>
                                                     </div>
                                                 </div>
                                             </div>  
                                        
      </div>

      <style>
        .pagination{
          padding-left: 450;
        }
        .form{
          display: flex;
        }
        .form .control-group{
       
          margin-right: 15px;
          margin-bottom: 15px;
        }
        #example1_info {
   padding: 25px 0;
  }
  
  .pagination {
   /* padding-left: 1015px; */
   float: right;
  }
      </style>
     
   
     <div class="box">
            <div class="box-header">
              <h3 class="box-title"></h3>
              <div class="box-tools pull-right">
                         
                        </div>
            </div>
            <div class="table-responsive">
           
            <div class="box-body">
            

               <table id="example" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th>S.No</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Claim Amount(JW)</th>
                  <th>From Address</th>
                  <th>To Address</th>
                  <th>Transaction Hash</th>
                  <th>Created on</th>
                  <th>Status</th>
                  
                </tr>
                </thead>
               
                <tbody id="users_withdraw_id">


                 {% if withdraw_qs %}
                 {% for item in withdraw_qs %}
                 <tr>
                  <td>{{ forloop.counter}}</td>
                  <td>{{ item.userid.user_name}}</td>
                  <td>{{ item.Amount}}</td>
                  <td>{{item.Withdraw_fee}}</td>
                  <td>{{item.Withdraw_USDT}}</td>
                  <td>{{item.Withdraw_JW}}</td>
                  <td>{{ item.Address}}</td>
                  <td><a class="btn" href="https://bscscan.com/tx/{{item.Transaction_Hash}}/" title="Change Status" target="_blank" ><i class="fa fa-external-link"></i>  </a>
                  </td>
                  <td>{{item.created_on}}</td>
                  <td> {% if item.status == 0 %}
                          Active
                          {% endif %}
                       {%if item.status == 2%}
                        Cancelled
                      {% endif %}
                      {%if item.status == 1%}
                        Completed
                      {% endif %}
                  </td>
                  
                   
                </tr>
                 {% endfor %}
                {% else %}
                     <tr><td colspan=5><h5>There are no records yet</h5></td></tr>
                {% endif %}
              </tbody>
               </table>

            </div>

            <div class="row">
              <div class="col-sm-5">
                <div class="dataTables_info" id="example1_info" role="status" aria-live="polite">
                  Showing {{start_value}} to {{end_value}} of {{usr_count}} entries
                </div>
                </div>
            <div class="paginattion-inn d-flex justify-content-end" >
              <div class="col-sm-7">
              {% if withdraw_qs.has_other_pages %}
              <ul class="pagination pagination mr-md-4">
                 {% if withdraw_qs.has_previous %}
                <li class="page-item"><a class="page-link font-secondary" href="?pageno={{ withdraw_qs.previous_page_number }}"><i class="fas fa-long-arrow-alt-left mr-2"></i>Previous</a></li>
                {% else %}
                <li class="page-item"><a class="page-link font-secondary" href="#"><i class="fas fa-long-arrow-alt-left mr-2"></i>Previous</a></li>
                {% endif %}
                {% for i in withdraw_qs.paginator.page_range %}
                {% if withdraw_qs.number == i %}
                <li class="page-item"><a class="page-link font-secondary " href="#">{{ i }}</a></li>
                {% else %}
                {% if request.GET.user != None %} 
                <li class="page-item"><a class="page-link font-secondary " href="?submit=Search&pageno={{ i }}">{{ i }}</a></li>
                {% else %}
                {% if  i == startpage %}
                <li class="page-item"><a class="page-link font-secondary " href="?pageno={{ i }}">{{ i }}</a></li>
                {% elif i == endpage %}
                <li class="page-item"><a class="page-link font-secondary " href="?pageno={{ i }}">{{ i }}</a></li>
                {% endif %}
                {% endif %}
                {% endif %}
                {% endfor %}
                 {% if withdraw_qs.has_next %}
                <li class="page-item"><a class="page-link font-secondary" href="?pageno={{ withdraw_qs.next_page_number }}">Next <i class="fas fa-long-arrow-alt-right ml-2"></i></a></li>
                {% else %}
                <li class="page-item"><a class="page-link font-secondary" href="#">Next <i class="fas fa-long-arrow-alt-right ml-2"></i></a></li>
                {% endif %}
              </ul>
              {% endif %}
              </div>
              </div>
            </div>
            
             </div>
            
          </div>
          <!-- <div class="dataTables_info" id="example1_info" role="status" aria-live="polite">
            Showing {{table.get_start_index}} to {{table.get_end_index}} of {{user_count}} entries
          </div> -->
        
      </div>

    </section>
 {% endblock Content_Area %}
 {% block Java_Scripts %}

 <script>
  function search_table(){
    
     var user = $("#all_user_list").val();
     var obj = JSON.parse(user)
     
     var len = Object.keys(obj).length
     if (obj) {
       
       $("#users_withdraw_id").empty();
     k = 1
     for (var i = 0; i < len; i++) {
       table = ("<td>"+obj[i+1].sno+"</td><td>"+obj[i+1].username+"</td><td>"+obj[i+1].email+"</td><td>"+obj[i+1].Amount+"</td><td>"+obj[i+1].frm_addrs+"</td><td>"+obj[i+1].to_addrs+"</td><td>"+"<a class='btn' href='https://bscscan.com/tx/"+obj[i+1].Transaction_Hash+"/' title='Hash' target='_blank'><i class='fa fa-external-link'></i></a></td><td>"+obj[i+1].date+"</td>");  
      //  table1 = ("<td>"+obj[i+1].date+"</td><td>"+obj[i+1].user_type+"</td");
        
       if (obj[i+1].status == 0) {
        
         $("#users_withdraw_id").append("<tr>"+table+"<td>"+"Active"+"</td></tr>")
         k++;
       }if(obj[i+1].status == 2){
         
         $("#users_withdraw_id").append("<tr>"+table+"<td>"+"Cancelled"+"</td></tr>")
         k++;
       }if(obj[i+1].status == 1){
         
         $("#users_withdraw_id").append("<tr>"+table+"<td>"+"Completed"+"</td></tr>")
         k++;
       }
         
     }
     } else {
       
     }
     
  }
  search_table()
</script>


<script>
  $("#reset-search").click(function(){
     window.location = "/tradeadmin/List_Send_Withdraw_History/";
     });
   
</script>

<script src="https://cdn.tutorialjinni.com/jquery-csv/1.0.11/jquery.csv.min.js"></script>

<script>
  function Send_Withdraw_CSV_file_ajax() {
    var user_obj_id = $("#user_id").val();
    $("#loader_spin_id").show();
     $.ajax({
         type: "POST",
         url: '/tradeadmin/download_csv_send_withdraw_report/', 
         data: {
             start_date : $("#id_start_date").val(), 
             end_date : $("#id_end_date").val(), 
             csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
         },
         success:function(data)
         {
           if(data.start_date != "" && data.end_date != ""){
              if(data.start_date <= data.end_date){
                  if(data.data != ""){
                    
                      if (data.status == "true") {
                        
                        const str_date = data.start_date
                        const end_date = data.end_date

                        const csv = $.csv.fromObjects(data.data);
                        downloadBlobAsFile(csv, str_date + '_to_' + end_date + ' transaction.csv' );
                        $("#loader_spin_id").hide();
                      } else {
                        alert("No records found !!!!")
                        $("#loader_spin_id").hide();
                      }
                }else{
                  alert("No records found.")
                  $("#loader_spin_id").hide();
              }
            }else{
              alert("Invalid end date.")
              $("#loader_spin_id").hide();
            }
          }else{
            alert("Make sure select date.")
            $("#loader_spin_id").hide();
          }
         },
     });
     };

    const downloadBlobAsFile = function(csv, filename){
      var downloadLink = document.createElement("a");
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = filename;
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

 </script>


<script>
  function end_date_validate(){
    var str_date = $("#id_start_date").val();
    var end_date = $("#id_end_date").val();
    
    if (str_date < end_date){
      document.getElementById("blankMsgName").innerHTML = "";
    }else{
      document.getElementById("blankMsgName").innerHTML = "Select valid date";
    }

  }
</script>

<style>
/*-- -- -- -- -|| Loader Styles Start Here ||- -- -- -- --*/
.loader {
    background: rgba(0, 4, 10, 0.9) none repeat scroll 0 0;
    bottom: 0;
    height: 100%;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    width: 100%;
    z-index: 9999;
}
.spinner {
    height: 40px;
    margin: auto;
    position: absolute;
    width: 40px;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
}
.double-bounce1, .double-bounce2 {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #fff;
    opacity: 0.6;
    position: absolute;
    top: 0;
    left: 0;
    -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
    animation: sk-bounce 2.0s infinite ease-in-out;
}
.double-bounce2 {
    -webkit-animation-delay: -1.0s;
    animation-delay: -1.0s;
}
/*-- -- -- -- -|| Loader Styles End Here ||- -- -- -- --*/

</style>


 {% endblock %}


